#!/bin/bash
# ==========================================
# Script interativo de configuração Docker Swarm
# Rodar em cada VM individualmente
# Criador: Cassiano Projetos IT
# ==========================================

# --- FUNÇÃO: Atualizar sistema e instalar dependências ---
atualizar_instalar() {
    echo "Atualizando pacotes..."
    sudo apt update && sudo apt upgrade -y
    echo "Instalando dependências básicas..."
    sudo apt install apt-transport-https ca-certificates curl software-properties-common -y
}

# --- FUNÇÃO: Configurar hostname e hosts ---
configurar_hosts() {
    echo "=== Configuração de hostname e /etc/hosts ==="
    read -p "Digite o hostname desta VM: " HOSTNAME_VM
    sudo hostnamectl set-hostname "$HOSTNAME_VM"

    read -p "Digite o IP desta VM: " IP_VM

    echo "Digite o número total de VMs no cluster (incluindo esta VM): "
    read NUM_VMS

    HOSTS_ENTRIES=""
    for ((i=1;i<=NUM_VMS;i++)); do
        read -p "Digite o IP da VM $i: " VM_IP
        read -p "Digite o hostname da VM $i: " VM_HOST
        HOSTS_ENTRIES+="$VM_IP $VM_HOST\n"
    done

    # Backup do hosts
    sudo cp /etc/hosts /etc/hosts.bak
    echo -e "$HOSTS_ENTRIES" | sudo tee -a /etc/hosts
    echo "/etc/hosts atualizado:"
    cat /etc/hosts
}

# --- FUNÇÃO: Instalar Docker ---
instalar_docker() {
    echo "=== Instalando Docker ==="
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    sudo usermod -aG docker $USER
    newgrp docker
    echo "Docker instalado com sucesso!"
    docker version
}

# --- FUNÇÃO: Inicializar Swarm ---
inicializar_swarm() {
    echo "=== Inicializando Docker Swarm ==="
    echo "Escolha o tipo de node:"
    echo "1) Manager"
    echo "2) Worker"
    read -p "Digite a opção (1 ou 2): " NODE_TYPE

    if [ "$NODE_TYPE" == "1" ]; then
        read -p "Digite o IP desta VM (advertise-addr): " IP_ADVERTISE
        SWARM_OUTPUT=$(docker swarm init --advertise-addr "$IP_ADVERTISE")
        echo "Swarm inicializado como manager!"
        echo "$SWARM_OUTPUT"

        # Mostra o token de join para workers
        WORKER_TOKEN=$(docker swarm join-token worker -q)
        echo "Token para adicionar workers: $WORKER_TOKEN"
        echo "Exemplo de comando para o worker:"
        echo "docker swarm join --token $WORKER_TOKEN $IP_ADVERTISE:2377"

    elif [ "$NODE_TYPE" == "2" ]; then
        read -p "Digite o IP do manager: " IP_MANAGER
        read -p "Cole aqui o token do Swarm recebido do manager: " WORKER_TOKEN
        docker swarm join --token $WORKER_TOKEN $IP_MANAGER:2377
        echo "Worker adicionado ao Swarm!"
    else
        echo "Opção inválida!"
        exit 1
    fi
}

# --- FUNÇÃO: Verificar status do Swarm ---
verificar_swarm() {
    echo "=== Status do Swarm nesta VM ==="
    docker info | grep Swarm
    if [ "$(docker info | grep Swarm | awk '{print $2}')" == "active" ]; then
        echo "Swarm ativo nesta VM!"
    else
        echo "Swarm inativo nesta VM!"
    fi
}

# --- EXECUÇÃO PRINCIPAL ---
echo "========================================="
echo "SCRIPT INTERATIVO DOCKER SWARM"
echo "========================================="

atualizar_instalar
configurar_hosts
instalar_docker
inicializar_swarm
verificar_swarm
